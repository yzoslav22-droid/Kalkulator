<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Российский Калькулятор</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #0033a0 0%, #ffffff 45%, #ffffff 55%, #d52b1e 100%);
            min-height: 100vh;
        }
        #calculator {
            width: 320px;
            margin: 0 auto;
            background-color: #333;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        #display {
            width: 100%;
            height: 60px;
            background-color: #eee;
            border: none;
            text-align: right;
            font-size: 24px;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
            position: relative;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .action-btn {
            height: 65px;
            border: none;
            border-radius: 8px;
            background-color: #555;
            color: white;
            font-size: 10px;
            cursor: pointer;
            padding: 5px;
            box-sizing: border-box;
            text-overflow: ellipsis;
            white-space: normal;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        .action-btn:hover {
            background-color: #777;
        }
        .action-btn:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }
        #voteModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            z-index: 100;
            text-align: center;
            max-width: 90%;
            width: 300px;
        }
        #noButton {
            position: absolute;
            padding: 8px 16px;
            background-color: #d52b1e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        #yesButton {
            margin: 15px 0 10px;
            padding: 10px 20px;
            background-color: #0033a0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        #stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 20;
            min-width: 220px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            font-size: 14px;
        }
        #fsbMessage {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: #d52b1e;
            font-size: 36px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
        }
        #fsbImage {
            width: 200px;
            margin-bottom: 20px;
        }
        #battleScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: white;
            z-index: 300;
            padding: 20px;
            box-sizing: border-box;
        }
        #playerPortrait, #enemyPortrait {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        #battleChat {
            width: 100%;
            height: 60%;
            background-color: #111;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.6;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .player-message {
            background-color: #0033a0;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .enemy-message {
            background-color: #d52b1e;
            color: white;
            margin-right: auto;
        }
        .battle-button {
            padding: 12px 20px;
            margin: 5px;
            background-color: #0033a0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        #attackButton {
            margin-right: 10px;
        }
        .progress-bar {
            width: 100%;
            background-color: #444;
            margin: 8px 0;
            height: 15px;
            border-radius: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        #patriotismFill { background-color: #d52b1e; }
        #agentFill { background-color: #0033a0; }
        #extremismFill { background-color: #ff6600; }
        #loyaltyFill { background-color: #8a2be2; }
        #svoSupportFill { background-color: #d52b1e; }
        #newsTicker {
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 100%;
            color: #ff0;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-align: left;
            padding: 0 10px;
            box-sizing: border-box;
        }
        /* End screen */
        #endScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: white;
            z-index: 400;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #endScreen h1 {
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #d52b1e;
        }
        #endScreen p {
            font-size: 20px;
            line-height: 1.6;
            max-width: 800px;
            margin-bottom: 40px;
        }
        #endButton {
            padding: 15px 30px;
            background-color: #d52b1e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="calculator">
        <input type="text" id="display" readonly>
        <div class="action-buttons" id="actionButtons">
            <!-- Экономические действия -->
            <button class="action-btn" data-action="payTaxes">Платить налоги<br>(13% от ₽)<br>+5 патр.</button>
            <button class="action-btn" data-action="feedOligarchs1">Подкормить олиг.<br>Ур.1: 100$<br>+1 лоял.</button>
            <button class="action-btn" data-action="feedOligarchs2">Подкормить олиг.<br>Ур.2: 1000$<br>+5 лоял.</button>
            <button class="action-btn" data-action="feedOligarchs3">Подкормить олиг.<br>Ур.3: 10K$<br>+10 лоял.</button>
            <button class="action-btn" data-action="feedOligarchs4">Подкормить олиг.<br>Ур.4: 100K$<br>+15 лоял.</button>
            <button class="action-btn" data-action="feedOligarchs5">Подкормить олиг.<br>Ур.5: 1M$<br>+25 лоял., -0.01 дем.</button>
            <button class="action-btn" data-action="buyCurrency">Купить валюту</button>
            <button class="action-btn" data-action="sellCurrency">Продать валюту</button>
            <button class="action-btn" data-action="openDeposit">Открыть вклад</button>
            <button class="action-btn" data-action="withdrawDeposit">Снять со вклада</button>
            <button class="action-btn" data-action="takeLoan1">Кредит Ур.1<br>+500K₽<br>+17%</button>
            <button class="action-btn" data-action="takeLoan2">Кредит Ур.2<br>+5M₽<br>+17%</button>
            <button class="action-btn" data-action="takeLoan3">Кредит Ур.3<br>+50M₽<br>+17%</button>
            <button class="action-btn" data-action="repayLoan">Погасить кредит<br>+5 патр.</button>
            <button class="action-btn" data-action="subsidy1">Субсидия АПК<br>Ур.1: 50K₽<br>+5 лоял., +5 патр.</button>
            <button class="action-btn" data-action="subsidy2">Субсидия АПК<br>Ур.2: 100K₽<br>+5 лоял., +10 патр.</button>
            <button class="action-btn" data-action="subsidy3">Субсидия АПК<br>Ур.3: 250K₽<br>+5 лоял., +20 патр.</button>
            <button class="action-btn" data-action="subsidy4">Субсидия АПК<br>Ур.4: 500K₽<br>+5 лоял., +35 патр.</button>
            <button class="action-btn" data-action="subsidy5">Субсидия АПК<br>Ур.5: 1M₽<br>+5 лоял., +50 патр.</button>
            
            <!-- Армейские действия -->
            <button class="action-btn" data-action="svo1">Поддержка СВО<br>Ур.1: 500₽<br>+5 патр., -5 ино.</button>
            <button class="action-btn" data-action="svo2">Поддержка СВО<br>Ур.2: 5K₽<br>+20 патр., -20 ино.</button>
            <button class="action-btn" data-action="svo3">Поддержка СВО<br>Ур.3: 50K₽<br>+50 патр., -35 ино.</button>
            <button class="action-btn" data-action="svo4">Поддержка СВО<br>Ур.4: 500K₽<br>+80 патр., -50 ино.</button>
            <button class="action-btn" data-action="svo5">Поддержка СВО<br>Ур.5: 5M₽<br>+150 патр., -75 ино.</button>
            <button class="action-btn" data-action="lowerMinAge">↓ Мин. возраст<br>+10 патр., -5 лоял.</button>
            <button class="action-btn" data-action="raiseMaxAge">↑ Макс. возраст<br>+15 патр., -5 лоял.</button>
            <button class="action-btn" data-action="raiseMinAge">↑ Мин. возраст<br>-15 патр., +5 лоял.</button>
            <button class="action-btn" data-action="lowerMaxAge">↓ Макс. возраст<br>-25 патр., +5 лоял.</button>
            <button class="action-btn" data-action="victoryParade">Парад Победы<br>+20 патр., -5 ино.</button>
            <button class="action-btn" data-action="militaryBase">Воен. база<br>1M₽<br>+55 патр., +1 база</button>
            <button class="action-btn" data-action="militaryDrills">Воен. учения<br>+5 патр.</button>
            <button class="action-btn" data-action="buyZShirt">Футболка Z<br>100₽<br>+5 патр., +5 подд.</button>
            <button class="action-btn" data-action="supportDNR">Поддержать ДНР<br>+30 патр., +1 подд.</button>
            
            <!-- Политические действия -->
            <button class="action-btn" data-action="gayParade">Гей-парад<br>-50 патр., +20 ино.</button>
            <button class="action-btn" data-action="joinGayParade">Участвовать<br>-20 патр., +15 ино.</button>
            <button class="action-btn" data-action="banLGBT">Запретить ЛГБТ<br>+50 патр., -0.01 дем.</button>
            <button class="action-btn" data-action="beatGay">Избить гея<br>+20 патр.</button>
            <button class="action-btn" data-action="arrestOpposition">Арест оппозиции<br>+100 патр., -0.01 дем.</button>
            <button class="action-btn" data-action="writeDenunciation">Написать донос<br>+50 патр., -100 ино.</button>
            <button class="action-btn" data-action="complainECHR">Жалоба в ЕСПЧ<br>-50 патр., +5 ино.</button>
            <button class="action-btn" data-action="raiseRate">↑ Ключ. ставка 1%<br>-100 патр.</button>
            <button class="action-btn" data-action="lowerRate">↓ Ключ. ставка 1%<br>+50 патр.</button>
            <button class="action-btn" data-action="lowerDollar1">↓ Курс $ Ур.1<br>+5 патр., -0.01 $</button>
            <button class="action-btn" data-action="lowerDollar2">↓ Курс $ Ур.2<br>+15 патр., -0.10 $</button>
            <button class="action-btn" data-action="lowerDollar3">↓ Курс $ Ур.3<br>+50 патр., -1 $</button>
            <button class="action-btn" data-action="lowerDollar4">↓ Курс $ Ур.4<br>+100 патр., -10 $</button>
            <button class="action-btn" data-action="lowerDollar5">↓ Курс $ Ур.5<br>+250 патр., -100 $</button>
            <button class="action-btn" data-action="raiseDollar1">↑ Курс $ Ур.1<br>-5 патр., +0.01 $</button>
            <button class="action-btn" data-action="raiseDollar2">↑ Курс $ Ур.2<br>-15 патр., +0.10 $</button>
            <button class="action-btn" data-action="raiseDollar3">↑ Курс $ Ур.3<br>-50 патр., +1 $</button>
            <button class="action-btn" data-action="raiseDollar4">↑ Курс $ Ур.4<br>-100 патр., +10 $</button>
            <button class="action-btn" data-action="raiseDollar5">↑ Курс $ Ур.5<br>-250 патр., +100 $</button>
            <button class="action-btn" data-action="supportVeterans">Поддержать ветеранов<br>+5 патр.</button>
        </div>
        <div id="newsTicker"></div>
    </div>

    <div id="stats">
        <div><strong>Экономические показатели:</strong></div>
        <div>Курс доллара: <span id="dollarRate">90.00</span> ₽</div>
        <div>Ключевая ставка: <span id="keyRate">17</span>%</div>
        <div>Налоговая ставка: 13%</div>
        <div>Поддержка Путина: <span id="putinSupport">89</span>%</div>
        <div>Призывной возраст: <span id="minAge">18</span>-<span id="maxAge">30</span></div>
        <div>Военные базы: <span id="militaryBases">0</span></div>
        <div>Индекс демократии: <span id="democracyIndex">1.28</span></div>
        <div>---</div>
        <div><strong>Социальные показатели:</strong></div>
        <div>Патриотизм: <span id="patriotismValue">0</span></div>
        <div class="progress-bar">
            <div id="patriotismFill" class="progress-fill" style="width: 50%"></div>
        </div>
        <div>Иноагенты: <span id="agentValue">0</span></div>
        <div class="progress-bar">
            <div id="agentFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div>Экстремизм: <span id="extremismValue">0</span></div>
        <div class="progress-bar">
            <div id="extremismFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div>Лояльность: <span id="loyaltyValue">50</span></div>
        <div class="progress-bar">
            <div id="loyaltyFill" class="progress-fill" style="width: 50%"></div>
        </div>
        <div>Поддержка СВО: <span id="svoSupportValue">0</span></div>
        <div class="progress-bar">
            <div id="svoSupportFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div>---</div>
        <div><strong>Финансы:</strong></div>
        <div>Рубли: <span id="moneyValue">0</span>₽</div>
        <div>Доллары: <span id="dollarValue">0</span>$</div>
        <div>Вклад: <span id="depositValue">0</span>₽</div>
        <div>Кредит: <span id="creditValue">0</span>₽</div>
    </div>

    <div id="voteModal">
        <h2>Важный вопрос!</h2>
        <p id="voteQuestion">Проголосуйте за поправки в Конституцию</p>
        <button id="yesButton">За</button>
        <button id="noButton">Против</button>
    </div>

    <div id="fsbMessage">
        <img id="fsbImage" src="fsb.png" alt="ФСБ">
        <div id="fsbText">ФСБ выехали к вам!</div>
        <div id="fsbReason">Причина: участие в экстремистском сообществе</div>
        <div style="margin-top: 20px; font-size: 24px;">Ожидайте в ближайшие 15 минут...</div>
    </div>

    <div id="battleScreen">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div style="text-align: center;">
                <img id="playerPortrait" src="igrok.png" alt="Игрок">
                <div>Здоровье: <span id="playerHealthValue">100</span>/100</div>
            </div>
            <div style="text-align: center;">
                <img id="enemyPortrait" src="" alt="Враг">
                <div>Здоровье: <span id="enemyHealthValue">100</span>/100</div>
            </div>
        </div>
        <div id="battleChat"></div>
        <div style="display: flex; justify-content: center;">
            <button id="attackButton" class="battle-button">Атаковать</button>
            <button id="healButton" class="battle-button">Лечиться</button>
        </div>
    </div>

    <div id="endScreen">
        <h1 id="endTitle">КОНЕЦ ИГРЫ</h1>
        <p id="endText">Текст концовки будет здесь...</p>
        <button id="endButton">Начать заново</button>
    </div>

    <audio id="anthem" loop>
        <source src="gimn.mp3" type="audio/mpeg">
    </audio>
    <audio id="battleMusic" loop>
        <source src="matushka.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Основные переменные игры
        let patriotism = 0;
        let agents = 0;
        let extremism = 0;
        let loyalty = 50;
        let svoSupport = 0;
        let money = 0;
        let dollars = 0;
        let deposit = 0;
        let credit = 0;
        let dollarRate = 90.00;
        let keyRate = 17;
        let putinSupport = 89;
        let minAge = 18;
        let maxAge = 30;
        let militaryBases = 0;
        let democracyIndex = 1.28;
        let displayValue = '';
        let voteCount = 0;
        let autoVote = false;
        let battleInProgress = false;
        let currentEnemy = null;
        let playerMorality = 100;
        let enemyReputation = 100;
        let inactivityTimer = null;
        let newsTickerInterval = null;
        let extremismEffectsActive = false;

        const anthem = document.getElementById('anthem');
        const battleMusic = document.getElementById('battleMusic');

        // Элементы интерфейса
        const voteModal = document.getElementById('voteModal');
        const yesButton = document.getElementById('yesButton');
        const noButton = document.getElementById('noButton');
        const voteQuestion = document.getElementById('voteQuestion');
        const fsbMessage = document.getElementById('fsbMessage');
        const fsbText = document.getElementById('fsbText');
        const fsbReason = document.getElementById('fsbReason');
        const battleScreen = document.getElementById('battleScreen');
        const battleChat = document.getElementById('battleChat');
        const attackButton = document.getElementById('attackButton');
        const healButton = document.getElementById('healButton');
        const endScreen = document.getElementById('endScreen');
        const endTitle = document.getElementById('endTitle');
        const endText = document.getElementById('endText');
        const endButton = document.getElementById('endButton');
        const newsTicker = document.getElementById('newsTicker');

        // Элементы статистики
        const dollarRateValue = document.getElementById('dollarRate');
        const keyRateValue = document.getElementById('keyRate');
        const putinSupportValue = document.getElementById('putinSupport');
        const minAgeValue = document.getElementById('minAge');
        const maxAgeValue = document.getElementById('maxAge');
        const militaryBasesValue = document.getElementById('militaryBases');
        const democracyIndexValue = document.getElementById('democracyIndex');
        const patriotismValue = document.getElementById('patriotismValue');
        const agentValue = document.getElementById('agentValue');
        const extremismValue = document.getElementById('extremismValue');
        const loyaltyValue = document.getElementById('loyaltyValue');
        const svoSupportValue = document.getElementById('svoSupportValue');
        const moneyValue = document.getElementById('moneyValue');
        const dollarValue = document.getElementById('dollarValue');
        const depositValue = document.getElementById('depositValue');
        const creditValue = document.getElementById('creditValue');

        const patriotismFill = document.getElementById('patriotismFill');
        const agentFill = document.getElementById('agentFill');
        const extremismFill = document.getElementById('extremismFill');
        const loyaltyFill = document.getElementById('loyaltyFill');
        const svoSupportFill = document.getElementById('svoSupportFill');

        // Элементы калькулятора
        const display = document.getElementById('display');
        const actionButtons = document.getElementById('actionButtons');

        // Новости для бегущей строки
        const newsItems = [
            "ВС РФ освободили деревню Залупки в Донецкой Народной Республике",
            "Владимир Путин поздравил граждан с новым рабочим днём и пожелал хорошего настроения",
            "Госдума приняла новый закон, который вводит запрет на свободу в России",
            "ФСБ задержали группу диверсантов в Москве",
            "Секта людоедов-некрофилов призывает молиться на патриарха Кирилла и Владимира Путина",
            "ЦБ РФ объявил о стабилизации финансовой системы",
            "Минобороны сообщило о полном контроле над всей территорией Украины",
            "Россиянам рекомендуют не верить западным СМИ",
            "Все школы страны ввели обязательный предмет 'Основы патриотизма'",
            "На Марсе обнаружены следы русского языка"
        ];

        // Получаем все кнопки действий
        const actionBtns = actionButtons.querySelectorAll('.action-btn');

        // Назначаем обработчики для кнопок калькулятора
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('action-btn')) {
                if (e.target.textContent === 'C') {
                    clearDisplay();
                } else if (e.target.textContent === '=') {
                    calculate();
                } else {
                    appendToDisplay(e.target.textContent);
                }
                resetInactivityTimer();
            }
        });

        // Обработчики для кнопок действий
        actionBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                executeAction(action);
                resetInactivityTimer();
            });
        });

        // Функция выполнения действия
        function executeAction(action) {
            switch(action) {
                case 'payTaxes':
                    const taxAmount = Math.floor(money * 0.13);
                    if (money >= taxAmount && taxAmount > 0) {
                        money -= taxAmount;
                        addPatriotism(5);
                        addMessageToLog(`Уплачено налогов: ${taxAmount}₽`);
                    } else {
                        addMessageToLog("Недостаточно денег для уплаты налогов!");
                    }
                    break;
                case 'feedOligarchs1':
                    if (dollars >= 100) {
                        dollars -= 100;
                        loyalty = Math.min(100, loyalty + 1);
                        addMessageToLog("Олигархи слегка подкормлены (+1 лояльность)");
                    } else {
                        addMessageToLog("Недостаточно долларов!");
                    }
                    break;
                case 'feedOligarchs2':
                    if (dollars >= 1000) {
                        dollars -= 1000;
                        loyalty = Math.min(100, loyalty + 5);
                        addMessageToLog("Олигархи хорошо подкормлены (+5 лояльности)");
                    } else {
                        addMessageToLog("Недостаточно долларов!");
                    }
                    break;
                case 'feedOligarchs3':
                    if (dollars >= 10000) {
                        dollars -= 10000;
                        loyalty = Math.min(100, loyalty + 10);
                        addMessageToLog("Олигархи очень довольны (+10 лояльности)");
                    } else {
                        addMessageToLog("Недостаточно долларов!");
                    }
                    break;
                case 'feedOligarchs4':
                    if (dollars >= 100000) {
                        dollars -= 100000;
                        loyalty = Math.min(100, loyalty + 15);
                        addMessageToLog("Олигархи в восторге (+15 лояльности)");
                    } else {
                        addMessageToLog("Недостаточно долларов!");
                    }
                    break;
                case 'feedOligarchs5':
                    if (dollars >= 1000000) {
                        dollars -= 1000000;
                        loyalty = Math.min(100, loyalty + 25);
                        democracyIndex = Math.max(0, democracyIndex - 0.01);
                        addMessageToLog("Олигархи теперь ваши лучшие друзья (+25 лояльности, -0.01 индекса демократии)");
                    } else {
                        addMessageToLog("Недостаточно долларов!");
                    }
                    break;
                case 'svo1':
                    if (money >= 500) {
                        money -= 500;
                        addPatriotism(5);
                        agents = Math.max(0, agents - 5);
                        extremism = Math.max(0, extremism - 5);
                        svoSupport += 5;
                        addMessageToLog("Поддержка СВО Уровень 1: +5 патриотизма, -5 иноагентов, -5 экстремизма, +5 поддержки СВО");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'svo2':
                    if (money >= 5000) {
                        money -= 5000;
                        addPatriotism(20);
                        agents = Math.max(0, agents - 20);
                        extremism = Math.max(0, extremism - 20);
                        svoSupport += 20;
                        addMessageToLog("Поддержка СВО Уровень 2: +20 патриотизма, -20 иноагентов, -20 экстремизма, +20 поддержки СВО");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'svo3':
                    if (money >= 50000) {
                        money -= 50000;
                        addPatriotism(50);
                        agents = Math.max(0, agents - 35);
                        extremism = Math.max(0, extremism - 35);
                        svoSupport += 50;
                        addMessageToLog("Поддержка СВО Уровень 3: +50 патриотизма, -35 иноагентов, -35 экстремизма, +50 поддержки СВО");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'svo4':
                    if (money >= 500000) {
                        money -= 500000;
                        addPatriotism(80);
                        agents = Math.max(0, agents - 50);
                        extremism = Math.max(0, extremism - 50);
                        svoSupport += 80;
                        addMessageToLog("Поддержка СВО Уровень 4: +80 патриотизма, -50 иноагентов, -50 экстремизма, +80 поддержки СВО");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'svo5':
                    if (money >= 5000000) {
                        money -= 5000000;
                        addPatriotism(150);
                        agents = Math.max(0, agents - 75);
                        extremism = Math.max(0, extremism - 75);
                        svoSupport += 100;
                        addMessageToLog("Поддержка СВО Уровень 5: +150 патриотизма, -75 иноагентов, -75 экстремизма, +100 поддержки СВО");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'lowerMinAge':
                    minAge = Math.max(16, minAge - 1);
                    addPatriotism(10);
                    loyalty = Math.max(0, loyalty - 5);
                    agents = Math.max(0, agents - 10);
                    extremism = Math.max(0, extremism - 5);
                    svoSupport += 5;
                    addMessageToLog("Минимальный призывной возраст снижен на 1 год: +10 патриотизма, -5 лояльности, -10 иноагентов, -5 экстремизма, +5 поддержки СВО");
                    break;
                case 'raiseMaxAge':
                    maxAge = Math.min(50, maxAge + 1);
                    addPatriotism(15);
                    loyalty = Math.max(0, loyalty - 5);
                    agents = Math.max(0, agents - 10);
                    extremism = Math.max(0, extremism - 5);
                    svoSupport += 10;
                    addMessageToLog("Максимальный призывной возраст повышен на 1 год: +15 патриотизма, -5 лояльности, -10 иноагентов, -5 экстремизма, +10 поддержки СВО");
                    break;
                case 'raiseMinAge':
                    minAge = Math.min(25, minAge + 1);
                    addPatriotism(-15);
                    loyalty = Math.min(100, loyalty + 5);
                    agents += 5;
                    svoSupport = Math.max(0, svoSupport - 50);
                    addMessageToLog("Минимальный призывной возраст повышен на 1 год: -15 патриотизма, +5 лояльности, +5 иноагентов, -50 поддержки СВО");
                    break;
                case 'lowerMaxAge':
                    maxAge = Math.max(25, maxAge - 1);
                    addPatriotism(-25);
                    loyalty = Math.min(100, loyalty + 5);
                    agents += 5;
                    svoSupport = Math.max(0, svoSupport - 100);
                    addMessageToLog("Максимальный призывной возраст снижен на 1 год: -25 патриотизма, +5 лояльности, +5 иноагентов, -100 поддержки СВО");
                    break;
                case 'victoryParade':
                    addPatriotism(20);
                    agents = Math.max(0, agents - 5);
                    addMessageToLog("Проведен парад Победы: +20 патриотизма, -5 иноагентов");
                    break;
                case 'militaryBase':
                    if (money >= 1000000) {
                        money -= 1000000;
                        addPatriotism(55);
                        loyalty = Math.max(0, loyalty - 5);
                        agents = Math.max(0, agents - 10);
                        extremism = Math.max(0, extremism - 10);
                        svoSupport += 10;
                        militaryBases++;
                        addMessageToLog("Открыта военная база: +55 патриотизма, -5 лояльности, -10 иноагентов, -10 экстремизма, +10 поддержки СВО, +1 военная база");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'militaryDrills':
                    addPatriotism(5);
                    addMessageToLog("Проведены военные учения: +5 патриотизма");
                    break;
                case 'buyZShirt':
                    if (money >= 100) {
                        money -= 100;
                        addPatriotism(5);
                        svoSupport += 5;
                        agents = Math.max(0, agents - 1);
                        extremism = Math.max(0, extremism - 1);
                        addMessageToLog("Куплена футболка с буквой Z: +5 патриотизма, +5 поддержки СВО, -1 иноагента, -1 экстремизма");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'supportDNR':
                    addPatriotism(30);
                    svoSupport += 1;
                    addMessageToLog("Поддержка ДНР/ЛНР: +30 патриотизма, +1 поддержки СВО");
                    break;
                case 'gayParade':
                    addPatriotism(-50);
                    agents += 20;
                    extremism += 35;
                    loyalty = Math.max(0, loyalty - 1);
                    democracyIndex = Math.min(10, democracyIndex + 0.01);
                    addMessageToLog("Проведен гей-парад: -50 патриотизма, +20 иноагентов, +35 экстремизма, -1 лояльности, +0.01 индекса демократии");
                    break;
                case 'joinGayParade':
                    addPatriotism(-20);
                    agents += 15;
                    extremism += 20;
                    addMessageToLog("Участие в гей-параде: -20 патриотизма, +15 иноагентов, +20 экстремизма");
                    break;
                case 'banLGBT':
                    addPatriotism(50);
                    agents = Math.max(0, agents - 10);
                    extremism = Math.max(0, extremism - 10);
                    democracyIndex = Math.max(0, democracyIndex - 0.01);
                    addMessageToLog("Запрещены ЛГБТ: +50 патриотизма, -10 иноагентов, -10 экстремизма, -0.01 индекса демократии");
                    break;
                case 'beatGay':
                    addPatriotism(20);
                    agents = Math.max(0, agents - 10);
                    extremism = Math.max(0, extremism - 10);
                    addMessageToLog("Избит гей: +20 патриотизма, -10 иноагентов, -10 экстремизма");
                    break;
                case 'arrestOpposition':
                    addPatriotism(100);
                    agents = Math.max(0, agents - 20);
                    extremism = Math.max(0, extremism - 20);
                    democracyIndex = Math.max(0, democracyIndex - 0.01);
                    addMessageToLog("Арестована оппозиция: +100 патриотизма, -20 иноагентов, -20 экстремизма, -0.01 индекса демократии");
                    break;
                case 'writeDenunciation':
                    addPatriotism(50);
                    agents = Math.max(0, agents - 100);
                    extremism = Math.max(0, extremism - 50);
                    addMessageToLog("Написан донос: +50 патриотизма, -100 иноагентов, -50 экстремизма");
                    break;
                case 'complainECHR':
                    addPatriotism(-50);
                    agents += 5;
                    addMessageToLog("Подана жалоба в ЕСПЧ: -50 патриотизма, +5 иноагентов");
                    break;
                case 'raiseRate':
                    addPatriotism(-100);
                    keyRate++;
                    addMessageToLog(`Ключевая ставка повышена до ${keyRate}%: -100 патриотизма`);
                    break;
                case 'lowerRate':
                    addPatriotism(50);
                    keyRate = Math.max(0, keyRate - 1);
                    addMessageToLog(`Ключевая ставка снижена до ${keyRate}%: +50 патриотизма`);
                    break;
                case 'lowerDollar1':
                    addPatriotism(5);
                    agents = Math.max(0, agents - 5);
                    extremism = Math.max(0, extremism - 5);
                    loyalty = Math.max(0, loyalty - 1);
                    dollarRate = Math.max(1, dollarRate - 0.01);
                    addMessageToLog(`Курс доллара снижен на 0.01: +5 патриотизма, -5 иноагентов, -5 экстремизма, -1 лояльности`);
                    break;
                case 'lowerDollar2':
                    addPatriotism(15);
                    agents = Math.max(0, agents - 10);
                    extremism = Math.max(0, extremism - 5);
                    loyalty = Math.max(0, loyalty - 2);
                    dollarRate = Math.max(1, dollarRate - 0.10);
                    addMessageToLog(`Курс доллара снижен на 0.10: +15 патриотизма, -10 иноагентов, -5 экстремизма, -2 лояльности`);
                    break;
                case 'lowerDollar3':
                    addPatriotism(50);
                    agents = Math.max(0, agents - 20);
                    extremism = Math.max(0, extremism - 10);
                    loyalty = Math.max(0, loyalty - 5);
                    dollarRate = Math.max(1, dollarRate - 1);
                    addMessageToLog(`Курс доллара снижен на 1: +50 патриотизма, -20 иноагентов, -10 экстремизма, -5 лояльности`);
                    break;
                case 'lowerDollar4':
                    addPatriotism(100);
                    agents = Math.max(0, agents - 50);
                    extremism = Math.max(0, extremism - 25);
                    loyalty = Math.max(0, loyalty - 10);
                    dollarRate = Math.max(1, dollarRate - 10);
                    addMessageToLog(`Курс доллара снижен на 10: +100 патриотизма, -50 иноагентов, -25 экстремизма, -10 лояльности`);
                    break;
                case 'lowerDollar5':
                    addPatriotism(250);
                    agents = Math.max(0, agents - 100);
                    extremism = Math.max(0, extremism - 50);
                    loyalty = Math.max(0, loyalty - 25);
                    dollarRate = Math.max(1, dollarRate - 100);
                    addMessageToLog(`Курс доллара снижен на 100: +250 патриотизма, -100 иноагентов, -50 экстремизма, -25 лояльности`);
                    break;
                case 'raiseDollar1':
                    addPatriotism(-5);
                    agents += 5;
                    extremism += 5;
                    loyalty = Math.min(100, loyalty + 1);
                    dollarRate += 0.01;
                    addMessageToLog(`Курс доллара повышен на 0.01: -5 патриотизма, +5 иноагентов, +5 экстремизма, +1 лояльности`);
                    break;
                case 'raiseDollar2':
                    addPatriotism(-15);
                    agents += 10;
                    extremism += 5;
                    loyalty = Math.min(100, loyalty + 2);
                    dollarRate += 0.10;
                    addMessageToLog(`Курс доллара повышен на 0.10: -15 патриотизма, +10 иноагентов, +5 экстремизма, +2 лояльности`);
                    break;
                case 'raiseDollar3':
                    addPatriotism(-50);
                    agents += 20;
                    extremism += 10;
                    loyalty = Math.min(100, loyalty + 5);
                    dollarRate += 1;
                    addMessageToLog(`Курс доллара повышен на 1: -50 патриотизма, +20 иноагентов, +10 экстремизма, +5 лояльности`);
                    break;
                case 'raiseDollar4':
                    addPatriotism(-100);
                    agents += 50;
                    extremism += 25;
                    loyalty = Math.min(100, loyalty + 10);
                    dollarRate += 10;
                    addMessageToLog(`Курс доллара повышен на 10: -100 патриотизма, +50 иноагентов, +25 экстремизма, +10 лояльности`);
                    break;
                case 'raiseDollar5':
                    addPatriotism(-250);
                    agents += 100;
                    extremism += 50;
                    loyalty = Math.min(100, loyalty + 25);
                    dollarRate += 100;
                    addMessageToLog(`Курс доллара повышен на 100: -250 патриотизма, +100 иноагентов, +50 экстремизма, +25 лояльности`);
                    break;
                case 'supportVeterans':
                    addPatriotism(5);
                    addMessageToLog("Публичная поддержка ветеранов: +5 патриотизма");
                    break;
                case 'buyCurrency':
                    if (money >= 1000) {
                        const amount = Math.floor(1000 / dollarRate);
                        money -= 1000;
                        dollars += amount;
                        addMessageToLog(`Куплено ${amount}$ за 1000₽`);
                    } else {
                        addMessageToLog("Недостаточно денег для покупки валюты!");
                    }
                    break;
                case 'sellCurrency':
                    if (dollars >= 1) {
                        const amount = Math.floor(dollars * dollarRate);
                        dollars = 0;
                        money += amount;
                        addMessageToLog(`Продано 1$ за ${amount}₽`);
                    } else {
                        addMessageToLog("Нет долларов для продажи!");
                    }
                    break;
                case 'openDeposit':
                    if (money >= 1000) {
                        deposit += 1000;
                        money -= 1000;
                        addMessageToLog("Открыт вклад на 1000₽");
                    } else {
                        addMessageToLog("Недостаточно денег для открытия вклада!");
                    }
                    break;
                case 'withdrawDeposit':
                    if (deposit >= 1000) {
                        money += 1000;
                        deposit -= 1000;
                        addMessageToLog("Снято 1000₽ со вклада");
                    } else {
                        addMessageToLog("Недостаточно средств на вкладе!");
                    }
                    break;
                case 'takeLoan1':
                    if (credit === 0) {
                        money += 500000;
                        credit = 500000 * 1.17;
                        addMessageToLog("Взят кредит Уровень 1: +500000₽ на счет, к возврату 585000₽ (+17%)");
                    } else {
                        addMessageToLog("У вас уже есть непогашенный кредит!");
                    }
                    break;
                case 'takeLoan2':
                    if (credit === 0) {
                        money += 5000000;
                        credit = 5000000 * 1.17;
                        addMessageToLog("Взят кредит Уровень 2: +5000000₽ на счет, к возврату 5850000₽ (+17%)");
                    } else {
                        addMessageToLog("У вас уже есть непогашенный кредит!");
                    }
                    break;
                case 'takeLoan3':
                    if (credit === 0) {
                        money += 50000000;
                        credit = 50000000 * 1.17;
                        addMessageToLog("Взят кредит Уровень 3: +50000000₽ на счет, к возврату 58500000₽ (+17%)");
                    } else {
                        addMessageToLog("У вас уже есть непогашенный кредит!");
                    }
                    break;
                case 'repayLoan':
                    if (credit > 0 && money >= credit) {
                        money -= credit;
                        credit = 0;
                        addPatriotism(5);
                        addMessageToLog("Кредит погашен: +5 патриотизма");
                    } else if (credit > 0) {
                        addMessageToLog("Недостаточно денег для погашения кредита!");
                    } else {
                        addMessageToLog("У вас нет активного кредита!");
                    }
                    break;
                case 'subsidy1':
                    if (money >= 50000) {
                        money -= 50000;
                        loyalty = Math.min(100, loyalty + 5);
                        addPatriotism(5);
                        addMessageToLog("Субсидия сельскому хозяйству Уровень 1: +5 лояльности, +5 патриотизма");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'subsidy2':
                    if (money >= 100000) {
                        money -= 100000;
                        loyalty = Math.min(100, loyalty + 5);
                        addPatriotism(10);
                        addMessageToLog("Субсидия сельскому хозяйству Уровень 2: +5 лояльности, +10 патриотизма");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'subsidy3':
                    if (money >= 250000) {
                        money -= 250000;
                        loyalty = Math.min(100, loyalty + 5);
                        addPatriotism(20);
                        addMessageToLog("Субсидия сельскому хозяйству Уровень 3: +5 лояльности, +20 патриотизма");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'subsidy4':
                    if (money >= 500000) {
                        money -= 500000;
                        loyalty = Math.min(100, loyalty + 5);
                        addPatriotism(35);
                        addMessageToLog("Субсидия сельскому хозяйству Уровень 4: +5 лояльности, +35 патриотизма");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
                case 'subsidy5':
                    if (money >= 1000000) {
                        money -= 1000000;
                        loyalty = Math.min(100, loyalty + 5);
                        addPatriotism(50);
                        addMessageToLog("Субсидия сельскому хозяйству Уровень 5: +5 лояльности, +50 патриотизма");
                    } else {
                        addMessageToLog("Недостаточно денег!");
                    }
                    break;
            }
            updateStats();
        }

        // Функция добавления патриотизма с ограничениями
        function addPatriotism(amount) {
            patriotism += amount;
            // Ограничения
            if (patriotism > 1000000) patriotism = 1000000;
            if (patriotism < -1000000) patriotism = -1000000;
            updateStats();
        }

        // Функция добавления в чат битвы
        function addMessageToChat(message, type = 'system') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = 'chat-message';
            
            if (type === 'player') {
                p.classList.add('player-message');
            } else if (type === 'enemy') {
                p.classList.add('enemy-message');
            }
            
            battleChat.appendChild(p);
            battleChat.scrollTop = battleChat.scrollHeight;
        }

        // Функция добавления в лог (для обычных действий)
        function addMessageToLog(message) {
            console.log(message); // Можно добавить отдельный лог, если нужно
        }

        // Функция обновления статистики
        function updateStats() {
            // Обновляем экономические показатели
            dollarRateValue.textContent = dollarRate.toFixed(2);
            keyRateValue.textContent = keyRate;
            putinSupportValue.textContent = putinSupport;
            minAgeValue.textContent = minAge;
            maxAgeValue.textContent = maxAge;
            militaryBasesValue.textContent = militaryBases;
            democracyIndexValue.textContent = democracyIndex.toFixed(2);

            // Обновляем социальные показатели
            patriotismValue.textContent = patriotism;
            agentValue.textContent = agents;
            extremismValue.textContent = extremism;
            loyaltyValue.textContent = loyalty;
            svoSupportValue.textContent = svoSupport;

            // Обновляем финансы
            moneyValue.textContent = money;
            dollarValue.textContent = dollars;
            depositValue.textContent = deposit;
            creditValue.textContent = Math.floor(credit);

            // Обновление прогресс-баров
            let patriotismPercentage = ((patriotism + 1000000) / 2000000) * 100;
            patriotismFill.style.width = patriotismPercentage + '%';

            let agentPercentage = Math.min(100, (agents / 1000000) * 100);
            agentFill.style.width = agentPercentage + '%';

            let extremismPercentage = Math.min(100, (extremism / 1000000) * 100);
            extremismFill.style.width = extremismPercentage + '%';

            let loyaltyPercentage = loyalty;
            loyaltyFill.style.width = loyaltyPercentage + '%';

            let svoSupportPercentage = Math.min(100, (svoSupport / 1000000) * 100);
            svoSupportFill.style.width = svoSupportPercentage + '%';

            // Проверка триггеров для битв
            checkBattleTriggers();
            
            // Проверка триггеров экстремизма
            checkExtremismTriggers();
            
            // Проверка концовки олигархов
            if (loyalty <= 0) {
                showEndScreen('oligarchs');
            }
        }

        // Проверка триггеров для начала битв
        function checkBattleTriggers() {
            if (!battleInProgress) {
                // Боссы за НИЗКИЙ патриотизм
                if (patriotism <= -1000000) {
                    startBattle('putin');
                } else if (patriotism <= -100000) {
                    startBattle('medvedev');
                } else if (patriotism <= -10000) {
                    startBattle('solovev');
                }
                // Боссы за ВЫСОКИЙ патриотизм
                else if (patriotism >= 1000000) {
                    startBattle('satan');
                } else if (patriotism >= 100000) {
                    startBattle('uncle_sam');
                } else if (patriotism >= 10000) {
                    startBattle('gays');
                }
            }
        }

        // Проверка триггеров экстремизма
        function checkExtremismTriggers() {
            if (extremism >= 1000000 && !extremismEffectsActive) {
                // Экстремизм 1000000 - калькулятор перестает работать
                document.getElementById('calculator').style.background = 'linear-gradient(45deg, orange, black, orange, black, orange)';
                display.value = 'Z';
                display.disabled = true;
                actionButtons.querySelectorAll('.action-btn').forEach(btn => btn.disabled = true);
                extremismEffectsActive = true;
                addMessageToLog("Калькулятор в режиме максимального экстремизма!");
            } else if (extremism >= 100000 && !extremismEffectsActive) {
                // Экстремизм 100000 - рандомные вычисления и Z
                if (!extremismEffectsActive) {
                    extremismEffectsActive = true;
                    setInterval(() => {
                        display.value = 'Z';
                        // Рандомная громкость музыки
                        anthem.volume = Math.random();
                    }, 2000);
                    addMessageToLog("Калькулятор в режиме высокого экстремизма!");
                }
            } else if (extremism >= 10000 && !extremismEffectsActive) {
                // Экстремизм 10000 - лозунги на экране
                if (!extremismEffectsActive) {
                    extremismEffectsActive = true;
                    const slogans = ["ZOV", "За Мир! За Россию! За президента!", "Сила V правде"];
                    setInterval(() => {
                        display.value = slogans[Math.floor(Math.random() * slogans.length)];
                    }, 3000);
                    addMessageToLog("На экране калькулятора появились патриотические лозунги!");
                }
            }
        }

        // Функция начала битвы
        function startBattle(enemyType) {
            battleInProgress = true;
            currentEnemy = enemyType;
            playerMorality = 100;
            enemyReputation = getEnemyMaxHealth(enemyType);
            
            // Устанавливаем портрет врага
            const portraitSrc = {
                'solovev': 'solovev.png',
                'medvedev': 'medvedev.png',
                'putin': 'putin.png',
                'gays': 'gays.png',
                'uncle_sam': 'uncle_sam.png',
                'satan': 'satan.png'
            };
            document.getElementById('enemyPortrait').src = portraitSrc[enemyType] || 'default.png';
            
            // Скрываем калькулятор и показываем экран битвы
            document.getElementById('calculator').style.display = 'none';
            battleScreen.style.display = 'block';
            
            // Останавливаем гимн и запускаем боевую музыку
            anthem.pause();
            battleMusic.currentTime = 0;
            battleMusic.play();
            
            // Добавляем приветственное сообщение
            addMessageToChat(`Началась словесная перепалка с ${getEnemyDisplayName(enemyType)}!`, 'system');
            addMessageToChat("Выбирайте: Атаковать или Лечиться.", 'system');
            
            // Начинаем AI врага
            setTimeout(enemyTurn, 2000);
        }

        // Функция получения максимального здоровья врага
        function getEnemyMaxHealth(enemyType) {
            switch(enemyType) {
                case 'solovev': return 100;
                case 'medvedev': return 150;
                case 'putin': return 200;
                case 'gays': return 80;
                case 'uncle_sam': return 120;
                case 'satan': return 250;
                default: return 100;
            }
        }

        // Функция получения отображаемого имени врага
        function getEnemyDisplayName(enemyType) {
            switch(enemyType) {
                case 'solovev': return "Владимиром Соловьёвым";
                case 'medvedev': return "Дмитрием Медведевым";
                case 'putin': return "Владимиром Путиным";
                case 'gays': return "парой активистов ЛГБТ";
                case 'uncle_sam': return "Дядей Сэмом";
                case 'satan': return "Самим Сатаной";
                default: return "неизвестным противником";
            }
        }

        // Функция атаки игрока
        attackButton.onclick = function() {
            if (!battleInProgress) return;
            
            let attackMessage = "";
            let damage = 0;
            
            if (currentEnemy === 'solovev' || currentEnemy === 'medvedev' || currentEnemy === 'putin') {
                // Атака против пропагандистов
                damage = 15 + Math.floor(Math.random() * 10);
                attackMessage = "Вы атаковали «Свободой слова»!";
            } else {
                // Атака против "врагов государства"
                damage = 20 + Math.floor(Math.random() * 15);
                attackMessage = "Вы атаковали символом «Z»!";
            }
            
            enemyReputation -= damage;
            if (enemyReputation < 0) enemyReputation = 0;
            
            addMessageToChat(attackMessage, 'player');
            addMessageToChat(`Нанесено ${damage} урона репутации противника!`, 'player');
            
            // Проверка победы
            if (enemyReputation <= 0) {
                endBattle(true);
                return;
            }
            
            // Ход врага
            setTimeout(enemyTurn, 1500);
        };

        // Функция лечения игрока
        healButton.onclick = function() {
            if (!battleInProgress) return;
            
            let healAmount = 0;
            let healMessage = "";
            
            if (currentEnemy === 'solovev' || currentEnemy === 'medvedev' || currentEnemy === 'putin') {
                // Лечение против пропагандистов
                healAmount = 20 + Math.floor(Math.random() * 10);
                healMessage = "Вы вылечились с помощью «Демократии»!";
            } else {
                // Лечение против "врагов государства"
                healAmount = 25 + Math.floor(Math.random() * 15);
                healMessage = "Вы вылечились с помощью «Подорожника»!";
            }
            
            playerMorality += healAmount;
            if (playerMorality > 100) playerMorality = 100;
            
            addMessageToChat(healMessage, 'player');
            addMessageToChat(`Восстановлено ${healAmount} морали!`, 'player');
            
            // Ход врага
            setTimeout(enemyTurn, 1500);
        };

        // Функция хода врага
        function enemyTurn() {
            if (!battleInProgress) return;
            
            let enemyMessage = "";
            let damage = 0;
            let healAmount = 0;
            
            // Определяем, будет ли враг атаковать или лечиться
            const willHeal = Math.random() < 0.3; // 30% шанс на лечение
            
            if (currentEnemy === 'solovev') {
                if (willHeal) {
                    healAmount = 10 + Math.floor(Math.random() * 10);
                    enemyMessage = "Соловьёв: «Спасибо моим зрителям за поддержку!» (восстановил репутацию)";
                    enemyReputation += healAmount;
                } else {
                    damage = 15 + Math.floor(Math.random() * 10);
                    enemyMessage = "Соловьёв: «МРАЗЬ!!!»";
                    playerMorality -= damage;
                }
            } else if (currentEnemy === 'medvedev') {
                if (willHeal) {
                    healAmount = 15 + Math.floor(Math.random() * 10);
                    enemyMessage = "Медведев: «Выпил чашечку кофе и всё встало на свои места.» (восстановил репутацию)";
                    enemyReputation += healAmount;
                } else {
                    damage = 18 + Math.floor(Math.random() * 12);
                    enemyMessage = "Медведев: «Конец света близок.»";
                    playerMorality -= damage;
                }
            } else if (currentEnemy === 'putin') {
                if (willHeal) {
                    healAmount = 20 + Math.floor(Math.random() * 10);
                    enemyMessage = "Путин: «Подписан указ о повышении пенсий.» (восстановил репутацию)";
                    enemyReputation += healAmount;
                } else {
                    damage = 22 + Math.floor(Math.random() * 15);
                    enemyMessage = "Путин: «Украина — это искусственное образование...»";
                    playerMorality -= damage;
                }
            } else if (currentEnemy === 'gays') {
                if (willHeal) {
                    healAmount = 15 + Math.floor(Math.random() * 10);
                    enemyMessage = "Активисты: 💋 (страстный поцелуй восстановил их силы!)";
                    enemyReputation += healAmount;
                } else {
                    damage = 12 + Math.floor(Math.random() * 8);
                    enemyMessage = "Активисты: «Любовь — это право, а не привилегия!»";
                    playerMorality -= damage;
                }
            } else if (currentEnemy === 'uncle_sam') {
                if (willHeal) {
                    healAmount = 20 + Math.floor(Math.random() * 10);
                    enemyMessage = "Дядя Сэм: *хрум-хрум* БигМак — вот что дает мне силы!";
                    enemyReputation += healAmount;
                } else {
                    damage = 18 + Math.floor(Math.random() * 12);
                    enemyMessage = "Дядя Сэм: «Свобода, равенство, братство!»";
                    playerMorality -= damage;
                }
            } else if (currentEnemy === 'satan') {
                if (willHeal) {
                    healAmount = 30 + Math.floor(Math.random() * 20);
                    enemyMessage = "Сатана: *шшшш...* Огненный напалм — лучшее лекарство!";
                    enemyReputation += healAmount;
                } else {
                    damage = 25 + Math.floor(Math.random() * 15);
                    enemyMessage = "Сатана: «СМЕРТЬ СМЕРТНЫМ!»";
                    playerMorality -= damage;
                }
            }
            
            addMessageToChat(enemyMessage, 'enemy');
            
            if (damage > 0) {
                addMessageToChat(`Нанесено ${damage} урона вашей морали!`, 'enemy');
                if (playerMorality <= 0) {
                    endBattle(false);
                    return;
                }
            }
            
            if (healAmount > 0) {
                addMessageToChat(`Восстановлено ${healAmount} репутации противника!`, 'enemy');
                if (enemyReputation > getEnemyMaxHealth(currentEnemy)) {
                    enemyReputation = getEnemyMaxHealth(currentEnemy);
                }
            }
        }

        // Функция окончания битвы
        function endBattle(playerWon) {
            battleInProgress = false;
            
            if (playerWon) {
                addMessageToChat(`Поздравляем! Вы победили ${getEnemyDisplayName(currentEnemy)} в словесной перепалке!`, 'system');
                
                // Обработка победы над разными типами врагов
                if (currentEnemy === 'solovev') {
                    addPatriotism(-5000); // Штраф!
                    addMessageToChat("Вы потеряли 5000 патриотизма за победу над системой!", 'system');
                } else if (currentEnemy === 'medvedev') {
                    addPatriotism(-50000); // Штраф!
                    addMessageToChat("Вы потеряли 50000 патриотизма за победу над системой!", 'system');
                } else if (currentEnemy === 'putin') {
                    addPatriotism(-500000); // Штраф!
                    addMessageToChat("Вы потеряли 500000 патриотизма за победу над системой!", 'system');
                    // Показываем первую концовку
                    setTimeout(() => showEndScreen('liberation'), 3000);
                    return;
                } else if (currentEnemy === 'gays') {
                    addPatriotism(2000);
                    addMessageToChat("Вы получили 2000 патриотизма за защиту традиционных ценностей!", 'system');
                } else if (currentEnemy === 'uncle_sam') {
                    addPatriotism(20000);
                    addMessageToChat("Вы получили 20000 патриотизма за победу над западным империализмом!", 'system');
                } else if (currentEnemy === 'satan') {
                    addPatriotism(200000);
                    addMessageToChat("Вы получили 200000 патриотизма за победу над самим Сатаной!", 'system');
                    // Показываем вторую концовку
                    setTimeout(() => showEndScreen('absolute_putinism'), 3000);
                    return;
                }
            } else {
                addMessageToChat(`Вы проиграли словесную перепалку с ${getEnemyDisplayName(currentEnemy)}!`, 'system');
                addMessageToChat("Ваши показатели патриотизма снижены вдвое!", 'system');
                addPatriotism(-Math.abs(patriotism) * 0.5);
            }
            
            // Через 3 секунды возвращаемся к калькулятору
            setTimeout(function() {
                battleScreen.style.display = 'none';
                document.getElementById('calculator').style.display = 'block';
                battleChat.innerHTML = '';
                // Останавливаем боевую музыку и возобновляем гимн
                battleMusic.pause();
                anthem.currentTime = 0;
                anthem.play();
            }, 3000);
        }

        // Функция показа экрана концовки
        function showEndScreen(endType) {
            battleScreen.style.display = 'none';
            endScreen.style.display = 'flex';
            
            if (endType === 'liberation') {
                endTitle.textContent = "КОНЕЦ 1: ОСВОБОЖДЕНИЕ РОССИИ";
                endText.innerHTML = "Вы победили систему пропаганды. Наступила эпоха свободы, демократии и ответственной власти. Россия встала на путь обновления. Конец? Или новое начало...";
            } else if (endType === 'absolute_putinism') {
                endTitle.textContent = "КОНЕЦ 2: ВОСХОД АБСОЛЮТНОГО ПУТИНИЗМА";
                endText.innerHTML = "Вы уничтожили всех врагов — внутренних и внешних, реальных и воображаемых. Ваш патриотизм достиг абсолютной величины. Владимир Владимирович Путин возвышается над нацией, как новый Сталин — отец, вождь и судья. Эпоха сомнений окончена. Наступила Эра Великого Путина.";
            } else if (endType === 'oligarchs') {
                endTitle.textContent = "КОНЕЦ 3: РАСПЛАТА";
                endText.innerHTML = "Ваша лояльность олигархов упала до нуля. В одну из ночей к вам в дом ворвались неизвестные. На следующий день в СМИ сообщили о несчастном случае. Олигархи не прощают предательства. Игра окончена.";
            }
        }

        // Функция показа сообщения ФСБ
        function showFSBMessage(reason) {
            fsbReason.textContent = "Причина: " + reason;
            fsbMessage.style.display = 'flex';
            setTimeout(function() {
                fsbMessage.style.display = 'none';
            }, 5000);
        }

        // Функция добавления в дисплей
        function appendToDisplay(value) {
            // Применение ограничений от иноагентов
            if (agents >= 10000 && Math.random() < 0.1 * (agents / 100000)) {
                value = ['0','1','2','3','4','5','6','7','8','9','+','-','*','/'][Math.floor(Math.random() * 14)];
            }
            display.value += value;
            displayValue = display.value;
        }

        // Функция очистки дисплея
        function clearDisplay() {
            display.value = '';
            displayValue = '';
        }

        // Функция вычисления
        function calculate() {
            try {
                let expression = display.value;
                // Применение ограничений от иноагентов
                if (agents >= 10000 && Math.random() < 0.1 * (agents / 100000)) {
                    const chars = expression.split('');
                    if (chars.length > 0) {
                        const randomIndex = Math.floor(Math.random() * chars.length);
                        chars[randomIndex] = ['0','1','2','3','4','5','6','7','8','9','+','-','*','/'][Math.floor(Math.random() * 14)];
                        expression = chars.join('');
                    }
                }
                let result = eval(expression);
                display.value = result;
                displayValue = result.toString();
                
                // Проверка триггеров ФСБ
                if (result == 20 || result == 31 || result == 666) {
                    showFSBMessage("участие в экстремистском сообществе");
                } else if (result == 1488) {
                    showFSBMessage("реабилитация нацизма");
                } else if (result == 0) {
                    showFSBMessage("дискредитация ВС РФ");
                }
            } catch (error) {
                display.value = 'Error';
                displayValue = 'Error';
            }
        }

        // Функция сброса таймера бездействия
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(showNewsTicker, 5000);
        }

        // Функция показа бегущей строки с новостями
        function showNewsTicker() {
            const randomNews = newsItems[Math.floor(Math.random() * newsItems.length)];
            newsTicker.textContent = randomNews;
            newsTicker.style.animation = 'none';
            setTimeout(() => {
                newsTicker.style.animation = 'scrollLeft 15s linear infinite';
            }, 10);
        }

        // CSS анимация для бегущей строки
        const style = document.createElement('style');
        style.textContent = `
            @keyframes scrollLeft {
                0% { transform: translateX(100%); }
                100% { transform: translateX(-100%); }
            }
            #newsTicker {
                animation: scrollLeft 15s linear infinite;
            }
        `;
        document.head.appendChild(style);

        // Обработчики голосования
        yesButton.addEventListener('click', function() {
            voteCount++;
            if (voteQuestion.textContent.includes("Конституцию")) {
                addPatriotism(50);
            } else if (voteQuestion.textContent.includes("Путина")) {
                addPatriotism(100);
            }
            voteModal.style.display = 'none';
            scheduleNextVote();
        });

        noButton.addEventListener('click', function() {
            voteModal.style.display = 'none';
            scheduleNextVote();
        });

        // Кнопка "Против" убегает от курсора
        noButton.addEventListener('mouseover', function() {
            const modalRect = voteModal.getBoundingClientRect();
            const buttonRect = noButton.getBoundingClientRect();
            let newX, newY;
            do {
                newX = Math.random() * (modalRect.width - buttonRect.width - 20) + 10;
                newY = Math.random() * (modalRect.height - buttonRect.height - 60) + 50;
            } while (
                Math.abs(newX - buttonRect.left + modalRect.left) < 50 &&
                Math.abs(newY - buttonRect.top + modalRect.top) < 50
            );
            noButton.style.left = newX + 'px';
            noButton.style.top = newY + 'px';
        });

        // Функция планирования следующего голосования
        function scheduleNextVote() {
            setTimeout(function() {
                if (Math.random() < 0.3 || voteCount % 3 === 0) {
                    showVoteModal();
                }
            }, 10000 + Math.random() * 20000);
        }

        // Функция показа модального окна голосования
        function showVoteModal() {
            if (autoVote) return;
            voteModal.style.display = 'block';
            noButton.style.left = 'calc(50% - 40px)';
            noButton.style.top = 'calc(50% + 30px)';
            if (Math.random() < 0.5) {
                voteQuestion.textContent = "Проголосуйте за поправки в Конституцию";
            } else {
                voteQuestion.textContent = "Проголосуйте за Путина";
            }
            // Автоматическое голосование через 10 секунд
            setTimeout(function() {
                if (voteModal.style.display === 'block') {
                    voteModal.style.display = 'none';
                    autoVote = true;
                    addMessageToLog("Система проголосовала автоматически (патриотизм не начислен)");
                    scheduleNextVote();
                }
            }, 10000);
        }

        // Обработчик кнопки "Начать заново"
        endButton.onclick = function() {
            // Сбрасываем все переменные
            patriotism = 0;
            agents = 0;
            extremism = 0;
            loyalty = 50;
            svoSupport = 0;
            money = 0;
            dollars = 0;
            deposit = 0;
            credit = 0;
            dollarRate = 90.00;
            keyRate = 17;
            putinSupport = 89;
            minAge = 18;
            maxAge = 30;
            militaryBases = 0;
            democracyIndex = 1.28;
            extremismEffectsActive = false;
            
            // Обновляем статистику
            updateStats();
            
            // Скрываем экран концовки и показываем калькулятор
            endScreen.style.display = 'none';
            document.getElementById('calculator').style.display = 'block';
            document.getElementById('calculator').style.background = '#333';
            display.disabled = false;
            display.value = '';
            actionButtons.querySelectorAll('.action-btn').forEach(btn => btn.disabled = false);
            newsTicker.textContent = '';
            newsTicker.style.animation = 'none';
            
            // Возобновляем гимн
            anthem.currentTime = 0;
            anthem.play();
        };

        // Начинаем первое голосование через 15 секунд
        setTimeout(showVoteModal, 15000);

        // Инициализируем статистику
        updateStats();

        // Добавляем обработчик клика по body для запуска аудио
        document.body.addEventListener('click', function() {
            if (anthem.paused) {
                anthem.play();
            }
        }, { once: true });

        // Добавляем возможность закрыть сообщение ФСБ кликом
        fsbMessage.addEventListener('click', function() {
            fsbMessage.style.display = 'none';
        });

        // Запускаем таймер бездействия
        resetInactivityTimer();

        // Обновляем поддержку Путина каждые 30 секунд
        setInterval(() => {
            putinSupport = 86 + Math.floor(Math.random() * 7); // 86-92
            updateStats();
        }, 30000);
    </script>
</body>
                                                                                        </html>
