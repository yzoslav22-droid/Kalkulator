<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Российский Калькулятор</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #0033a0 0%, #ffffff 45%, #ffffff 55%, #d52b1e 100%);
            min-height: 100vh;
        }
        #calculator {
            width: 320px;
            margin: 0 auto;
            background-color: #333;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        #display {
            width: 100%;
            height: 60px;
            background-color: #eee;
            border: none;
            text-align: right;
            font-size: 24px;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            height: 45px;
            border: none;
            border-radius: 8px;
            background-color: #555;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0 5px;
            box-sizing: border-box;
            text-overflow: ellipsis;
            white-space: normal;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        button:hover {
            background-color: #777;
        }
        button.decision-btn {
            font-size: 11px;
            height: 55px;
            padding: 5px;
            white-space: normal;
            line-height: 1.1;
        }
        #voteModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            z-index: 100;
            text-align: center;
            max-width: 90%;
            width: 300px;
        }
        #noButton {
            position: absolute;
            padding: 8px 16px;
            background-color: #d52b1e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        #yesButton {
            margin: 15px 0 10px;
            padding: 10px 20px;
            background-color: #0033a0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        #stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 20;
            min-width: 200px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #fsbMessage {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: #d52b1e;
            font-size: 36px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
        }
        #fsbImage {
            width: 200px;
            margin-bottom: 20px;
        }
        #battleScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: white;
            z-index: 300;
            padding: 20px;
            box-sizing: border-box;
        }
        .battle-character {
            position: absolute;
            width: 180px;
            height: 270px;
            object-fit: cover;
            border: 3px solid gold;
            border-radius: 10px;
        }
        #playerCharacter {
            bottom: 60px;
            left: 80px;
        }
        #enemyCharacter {
            bottom: 60px;
            right: 80px;
        }
        #battleLog {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 200px;
            background-color: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            overflow-y: auto;
            font-size: 14px;
            color: #fff;
        }
        .battle-button {
            position: absolute;
            bottom: 30px;
            padding: 12px 20px;
            margin: 5px;
            background-color: #0033a0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        #attackButton {
            left: 38%;
        }
        #healButton {
            left: 57%;
        }
        .progress-bar {
            width: 100%;
            background-color: #444;
            margin: 8px 0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        #patriotismFill {
            background-color: #d52b1e;
        }
        #agentFill {
            background-color: #0033a0;
        }
        #playerHealthFill {
            background-color: #00ff00;
        }
        #enemyHealthFill {
            background-color: #d52b1e;
        }
        
        /* Mode switch buttons */
        .mode-switch {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }
        
        .mode-switch button {
            flex: 1;
            height: 40px;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="calculator">
        <input type="text" id="display" readonly>
        <div class="buttons" id="mainButtons">
            <button>7</button>
            <button>8</button>
            <button>9</button>
            <button>/</button>
            <button>4</button>
            <button>5</button>
            <button>6</button>
            <button>*</button>
            <button>1</button>
            <button>2</button>
            <button>3</button>
            <button>-</button>
            <button>0</button>
            <button>C</button>
            <button>=</button>
            <button>+</button>
        </div>
        <div class="buttons" id="economyButtons" style="display: none;">
            <button class="decision-btn">Платить налоги<br>(+5 патриотизма)</button>
            <button class="decision-btn">Кормить олигархов<br>($100)</button>
            <button class="decision-btn">Инвестировать в<br>гособлигации</button>
            <button class="decision-btn">Поддержать СВО<br>(500₽)</button>
            <button class="decision-btn">Купить золото ЦБ</button>
            <button class="decision-btn">Открыть вклад<br>в Сбербанке</button>
            <button class="decision-btn">Продать валюту ЦБ</button>
            <button class="decision-btn">Кредит на<br>развитие бизнеса</button>
            <button class="decision-btn">Субсидия на<br>сельское хозяйство</button>
            <button class="decision-btn">Назад</button>
        </div>
        <div class="buttons" id="armyButtons" style="display: none;">
            <button class="decision-btn">Закупить новую<br>технику (1000₽)</button>
            <button class="decision-btn">Повысить зарплату<br>военным</button>
            <button class="decision-btn">Провести учения</button>
            <button class="decision-btn">Модернизировать<br>ядерное оружие</button>
            <button class="decision-btn">Открыть военную<br>базу за рубежом</button>
            <button class="decision-btn">Провести<br>парад Победы</button>
            <button class="decision-btn">Разработать<br>гиперзвуковое оружие</button>
            <button class="decision-btn">Увеличить<br>призывников</button>
            <button class="decision-btn">Поддержать<br>ветеранов</button>
            <button class="decision-btn">Назад</button>
        </div>
        <div class="buttons" id="politicsButtons" style="display: none;">
            <button class="decision-btn">Заключить союз<br>с Китаем (+50 п.)</button>
            <button class="decision-btn">Подать заявку<br>в НАТО (-100 п.)</button>
            <button class="decision-btn">Провести выборы<br>(+10 патриотизма)</button>
            <button class="decision-btn">Ужесточить цензуру<br>(-20 п., +30 ино.)</button>
            <button class="decision-btn">Разогнать оппозицию<br>(-50 п., +100 ино.)</button>
            <button class="decision-btn">Поддержать<br>ЛНР/ДНР (+30 п.)</button>
            <button class="decision-btn">Провести<br>референдум (+20 п.)</button>
            <button class="decision-btn">Арестовать<br>иноагентов (+10 п.)</button>
            <button class="decision-btn">Запретить ЛГБТ<br>(+15 патриотизма)</button>
            <button class="decision-btn">Назад</button>
        </div>
        <div class="mode-switch">
            <button>Экономика</button>
            <button>Армия</button>
            <button>Политика</button>
        </div>
    </div>

    <div id="stats">
        <div>Патриотизм: <span id="patriotismValue">0</span></div>
        <div class="progress-bar">
            <div id="patriotismFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div>Иноагенты: <span id="agentValue">0</span></div>
        <div class="progress-bar">
            <div id="agentFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div>Рубли: <span id="moneyValue">0</span>₽</div>
    </div>

    <div id="voteModal">
        <h2>Важный вопрос!</h2>
        <p id="voteQuestion">Проголосуйте за поправки в Конституцию</p>
        <button id="yesButton">За</button>
        <button id="noButton">Против</button>
    </div>

    <div id="fsbMessage">
        <img id="fsbImage" src="fsb.png" alt="ФСБ">
        <div id="fsbText">ФСБ выехали к вам!</div>
        <div id="fsbReason">Причина: участие в экстремистском сообществе</div>
        <div style="margin-top: 20px; font-size: 24px;">Ожидайте в ближайшие 15 минут...</div>
    </div>

    <div id="battleScreen">
        <div id="battleLog"></div>
        <img id="playerCharacter" src="igrok.png" alt="Игрок">
        <img id="enemyCharacter" src="" alt="Враг">
        <div style="position: absolute; bottom: 90px; left: 80px; width: 180px; text-align: center;">
            Здоровье игрока: <span id="playerHealthValue">100</span>/100
            <div class="progress-bar">
                <div id="playerHealthFill" class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        <div style="position: absolute; bottom: 90px; right: 80px; width: 180px; text-align: center;">
            Здоровье врага: <span id="enemyHealthValue">100</span>/100
            <div class="progress-bar">
                <div id="enemyHealthFill" class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        <button id="attackButton" class="battle-button">Атаковать (Свобода слова)</button>
        <button id="healButton" class="battle-button">Лечиться (Демократия)</button>
    </div>

    <audio id="anthem" loop>
        <source src="gimn.mp3" type="audio/mpeg">
    </audio>
    <audio id="battleMusic" loop>
        <source src="matushka.mp3" type="audio/mpeg">
    </audio>

    <script>
        let patriotism = 0;
        let agents = 0;
        let money = 0;
        let displayValue = '';
        let currentMode = 'main';
        let voteCount = 0;
        let autoVote = false;
        let battleInProgress = false;
        let enemy = null;
        let playerHealth = 100;
        let enemyHealth = 100;
        let enemyMaxHealth = 100;
        let fsbTimer = null;

        const anthem = document.getElementById('anthem');
        const battleMusic = document.getElementById('battleMusic');

        // Start playing the anthem
        anthem.play().catch(e => console.log("Audio autoplay prevented, will play on user interaction"));

        // Vote modal elements
        const voteModal = document.getElementById('voteModal');
        const yesButton = document.getElementById('yesButton');
        const noButton = document.getElementById('noButton');
        const voteQuestion = document.getElementById('voteQuestion');

        // FSB message elements
        const fsbMessage = document.getElementById('fsbMessage');
        const fsbText = document.getElementById('fsbText');
        const fsbReason = document.getElementById('fsbReason');

        // Battle elements
        const battleScreen = document.getElementById('battleScreen');
        const battleLog = document.getElementById('battleLog');
        const enemyCharacter = document.getElementById('enemyCharacter');
        const playerHealthValue = document.getElementById('playerHealthValue');
        const enemyHealthValue = document.getElementById('enemyHealthValue');
        const playerHealthFill = document.getElementById('playerHealthFill');
        const enemyHealthFill = document.getElementById('enemyHealthFill');

        // Stats elements
        const patriotismValue = document.getElementById('patriotismValue');
        const agentValue = document.getElementById('agentValue');
        const moneyValue = document.getElementById('moneyValue');
        const patriotismFill = document.getElementById('patriotismFill');
        const agentFill = document.getElementById('agentFill');

        // Display element
        const display = document.getElementById('display');
        const mainButtons = document.getElementById('mainButtons');
        const economyButtons = document.getElementById('economyButtons');
        const armyButtons = document.getElementById('armyButtons');
        const politicsButtons = document.getElementById('politicsButtons');

        // Get all buttons
        const numberButtons = mainButtons.querySelectorAll('button');
        const economyBtns = economyButtons.querySelectorAll('button');
        const armyBtns = armyButtons.querySelectorAll('button');
        const politicsBtns = politicsButtons.querySelectorAll('button');
        const modeSwitchButtons = document.querySelector('.mode-switch').querySelectorAll('button');

        // Assign click handlers to number buttons
        numberButtons[0].onclick = () => appendToDisplay('7');
        numberButtons[1].onclick = () => appendToDisplay('8');
        numberButtons[2].onclick = () => appendToDisplay('9');
        numberButtons[3].onclick = () => appendToDisplay('/');
        numberButtons[4].onclick = () => appendToDisplay('4');
        numberButtons[5].onclick = () => appendToDisplay('5');
        numberButtons[6].onclick = () => appendToDisplay('6');
        numberButtons[7].onclick = () => appendToDisplay('*');
        numberButtons[8].onclick = () => appendToDisplay('1');
        numberButtons[9].onclick = () => appendToDisplay('2');
        numberButtons[10].onclick = () => appendToDisplay('3');
        numberButtons[11].onclick = () => appendToDisplay('-');
        numberButtons[12].onclick = () => appendToDisplay('0');
        numberButtons[13].onclick = () => clearDisplay();
        numberButtons[14].onclick = () => calculate();
        numberButtons[15].onclick = () => appendToDisplay('+');

        // Assign click handlers to decision buttons
        economyBtns[0].onclick = () => makeDecision('Платить налоги (+5 патриотизма)');
        economyBtns[1].onclick = () => makeDecision('Кормить олигархов ($100)');
        economyBtns[2].onclick = () => makeDecision('Инвестировать в гособлигации');
        economyBtns[3].onclick = () => makeDecision('Поддержать СВО (500₽)');
        economyBtns[4].onclick = () => makeDecision('Купить золото ЦБ');
        economyBtns[5].onclick = () => makeDecision('Открыть вклад в Сбербанке');
        economyBtns[6].onclick = () => makeDecision('Продать валюту ЦБ');
        economyBtns[7].onclick = () => makeDecision('Кредит на развитие бизнеса');
        economyBtns[8].onclick = () => makeDecision('Субсидия на сельское хозяйство');
        economyBtns[9].onclick = () => switchToMain();

        armyBtns[0].onclick = () => makeDecision('Закупить новую технику (1000₽)');
        armyBtns[1].onclick = () => makeDecision('Повысить зарплату военным');
        armyBtns[2].onclick = () => makeDecision('Провести учения');
        armyBtns[3].onclick = () => makeDecision('Модернизировать ядерное оружие');
        armyBtns[4].onclick = () => makeDecision('Открыть военную базу за рубежом');
        armyBtns[5].onclick = () => makeDecision('Провести парад Победы');
        armyBtns[6].onclick = () => makeDecision('Разработать гиперзвуковое оружие');
        armyBtns[7].onclick = () => makeDecision('Увеличить призывников');
        armyBtns[8].onclick = () => makeDecision('Поддержать ветеранов');
        armyBtns[9].onclick = () => switchToMain();

        politicsBtns[0].onclick = () => makeDecision('Заключить союз с Китаем (+50 патриотизма)');
        politicsBtns[1].onclick = () => makeDecision('Подать заявку в НАТО (-100 патриотизма, +50 иноагентов)');
        politicsBtns[2].onclick = () => makeDecision('Провести выборы (+10 патриотизма)');
        politicsBtns[3].onclick = () => makeDecision('Ужесточить цензуру (-20 патриотизма, +30 иноагентов)');
        politicsBtns[4].onclick = () => makeDecision('Разогнать оппозицию (-50 патриотизма, +100 иноагентов)');
        politicsBtns[5].onclick = () => makeDecision('Поддержать ЛНР/ДНР (+30 патриотизма)');
        politicsBtns[6].onclick = () => makeDecision('Провести референдум (+20 патриотизма)');
        politicsBtns[7].onclick = () => makeDecision('Арестовать иноагентов (+10 патриотизма)');
        politicsBtns[8].onclick = () => makeDecision('Запретить ЛГБТ (+15 патриотизма)');
        politicsBtns[9].onclick = () => switchToMain();

        // Assign click handlers to mode switch buttons
        modeSwitchButtons[0].onclick = () => switchToEconomy();
        modeSwitchButtons[1].onclick = () => switchToArmy();
        modeSwitchButtons[2].onclick = () => switchToPolitics();

        // Make no button run away from cursor
        noButton.addEventListener('mouseover', function() {
            const modalRect = voteModal.getBoundingClientRect();
            const buttonRect = noButton.getBoundingClientRect();
            
            let newX, newY;
            do {
                newX = Math.random() * (modalRect.width - buttonRect.width - 20) + 10;
                newY = Math.random() * (modalRect.height - buttonRect.height - 60) + 50;
            } while (
                Math.abs(newX - buttonRect.left + modalRect.left) < 50 &&
                Math.abs(newY - buttonRect.top + modalRect.top) < 50
            );
            
            noButton.style.left = newX + 'px';
            noButton.style.top = newY + 'px';
        });

        // Vote handlers
        yesButton.addEventListener('click', function() {
            voteCount++;
            if (voteQuestion.textContent.includes("Конституцию")) {
                addPatriotism(50);
            } else if (voteQuestion.textContent.includes("Путина")) {
                addPatriotism(100);
            }
            voteModal.style.display = 'none';
            scheduleNextVote();
        });

        noButton.addEventListener('click', function() {
            // This should almost never happen due to the button running away
            voteModal.style.display = 'none';
            scheduleNextVote();
        });

        function scheduleNextVote() {
            setTimeout(function() {
                if (Math.random() < 0.3 || voteCount % 3 === 0) {
                    showVoteModal();
                }
            }, 10000 + Math.random() * 20000);
        }

        function showVoteModal() {
            if (autoVote) return;
            
            voteModal.style.display = 'block';
            noButton.style.left = 'calc(50% - 40px)';
            noButton.style.top = 'calc(50% + 30px)';
            
            if (Math.random() < 0.5) {
                voteQuestion.textContent = "Проголосуйте за поправки в Конституцию";
            } else {
                voteQuestion.textContent = "Проголосуйте за Путина";
            }
            
            // Auto vote after 10 seconds if player doesn't vote
            setTimeout(function() {
                if (voteModal.style.display === 'block') {
                    voteModal.style.display = 'none';
                    autoVote = true;
                    addMessageToLog("Калькулятор проголосовал автоматически (патриотизм не начислен)");
                    scheduleNextVote();
                }
            }, 10000);
        }

        function addPatriotism(amount) {
            patriotism += amount;
            updateStats();
            
            // Check for battle triggers
            if (patriotism <= -10000 && !battleInProgress) {
                startBattle('solovev');
            } else if (patriotism <= -100000 && !battleInProgress) {
                startBattle('medvedev');
            } else if (patriotism <= -1000000 && !battleInProgress) {
                startBattle('putin');
            }
        }

        function addAgents(amount) {
            agents += amount;
            updateStats();
            
            // Apply agent restrictions
            applyAgentRestrictions();
        }

        function updateStats() {
            patriotismValue.textContent = patriotism;
            agentValue.textContent = agents;
            moneyValue.textContent = money;
            
            // Update progress bars
            let patriotismPercentage = Math.max(0, Math.min(100, (patriotism + 1000000) / 2000000 * 100));
            patriotismFill.style.width = patriotismPercentage + '%';
            
            let agentPercentage = Math.min(100, agents / 10000 * 100);
            agentFill.style.width = agentPercentage + '%';
            
            // Calculate money based on patriotism
            if (patriotism >= 100) {
                money = Math.floor(patriotism / 100) * 5;
                if (patriotism >= 1000) {
                    money = Math.floor(patriotism / 1000) * 10;
                }
                if (patriotism >= 10000) {
                    money = Math.floor(patriotism / 10000) * 15;
                }
                // Continue the pattern...
                if (patriotism >= 100000) {
                    money = Math.floor(patriotism / 100000) * 20;
                }
                if (patriotism >= 1000000) {
                    money = Math.floor(patriotism / 1000000) * 25;
                }
            } else {
                money = 0;
            }
            moneyValue.textContent = money;
        }

        function applyAgentRestrictions() {
            // Apply restrictions based on agent level
            if (agents >= 100) {
                // Small chance of wrong calculations
                if (Math.random() < 0.1) {
                    // Calculator will sometimes modify inputs
                }
            }
            if (agents >= 500) {
                // Higher chance of wrong calculations
                if (Math.random() < 0.2) {
                    // Calculator will sometimes modify inputs
                }
            }
            if (agents >= 1000) {
                // Calculator sometimes performs calculations automatically
                if (Math.random() < 0.1) {
                    setTimeout(calculate, 1000 + Math.random() * 2000);
                }
            }
            if (agents >= 5000) {
                // Calculator frequently modifies inputs
                if (Math.random() < 0.3) {
                    // Modify display value
                }
            }
            if (agents >= 10000) {
                // Calculator constantly interferes
                if (Math.random() < 0.5) {
                    // Modify display value or calculate automatically
                }
            }
        }

        function switchToEconomy() {
            mainButtons.style.display = 'none';
            economyButtons.style.display = 'grid';
            armyButtons.style.display = 'none';
            politicsButtons.style.display = 'none';
            currentMode = 'economy';
        }

        function switchToArmy() {
            mainButtons.style.display = 'none';
            economyButtons.style.display = 'none';
            armyButtons.style.display = 'grid';
            politicsButtons.style.display = 'none';
            currentMode = 'army';
        }

        function switchToPolitics() {
            mainButtons.style.display = 'none';
            economyButtons.style.display = 'none';
            armyButtons.style.display = 'none';
            politicsButtons.style.display = 'grid';
            currentMode = 'politics';
        }

        function switchToMain() {
            mainButtons.style.display = 'grid';
            economyButtons.style.display = 'none';
            armyButtons.style.display = 'none';
            politicsButtons.style.display = 'none';
            currentMode = 'main';
        }

        function makeDecision(decision) {
            addMessageToLog("Принято решение: " + decision);
            
            // Process decision
            if (decision.includes("Платить налоги")) {
                addPatriotism(5);
            } else if (decision.includes("Кормить олигархов")) {
                if (money >= 100) {
                    money -= 100;
                    addPatriotism(10);
                } else {
                    addMessageToLog("Недостаточно денег!");
                }
            } else if (decision.includes("Поддержать СВО")) {
                if (money >= 500) {
                    money -= 500;
                    addPatriotism(50);
                } else {
                    addMessageToLog("Недостаточно денег!");
                }
            } else if (decision.includes("Заключить союз с Китаем")) {
                addPatriotism(50);
            } else if (decision.includes("Подать заявку в НАТО")) {
                addPatriotism(-100);
                addAgents(50);
            } else if (decision.includes("Ужесточить цензуру")) {
                addPatriotism(-20);
                addAgents(30);
            } else if (decision.includes("Разогнать оппозицию")) {
                addPatriotism(-50);
                addAgents(100);
            } else if (decision.includes("Поддержать ЛНР/ДНР")) {
                addPatriotism(30);
            } else if (decision.includes("Запретить ЛГБТ")) {
                addPatriotism(15);
            } else if (decision.includes("Арестовать иноагентов")) {
                addPatriotism(10);
                addAgents(-20);
            }
            
            updateStats();
            switchToMain();
        }

        function appendToDisplay(value) {
            // Apply agent restrictions - sometimes modify input
            if (agents >= 100 && Math.random() < 0.1 * (agents / 1000)) {
                value = ['0','1','2','3','4','5','6','7','8','9','+','-','*','/'][Math.floor(Math.random() * 14)];
            }
            
            display.value += value;
            displayValue = display.value;
        }

        function clearDisplay() {
            display.value = '';
            displayValue = '';
        }

        function calculate() {
            try {
                // Apply agent restrictions - sometimes modify calculation
                let expression = display.value;
                if (agents >= 100 && Math.random() < 0.1 * (agents / 1000)) {
                    // Modify expression
                    const chars = expression.split('');
                    if (chars.length > 0) {
                        const randomIndex = Math.floor(Math.random() * chars.length);
                        chars[randomIndex] = ['0','1','2','3','4','5','6','7','8','9','+','-','*','/'][Math.floor(Math.random() * 14)];
                        expression = chars.join('');
                    }
                }
                
                let result = eval(expression);
                display.value = result;
                displayValue = result.toString();
                
                // Check for FSB triggers
                if (result == 20 || result == 31 || result == 666) {
                    showFSBMessage("участие в экстремистском сообществе");
                } else if (result == 1488) {
                    showFSBMessage("реабилитация нацизма");
                } else if (result == 0) {
                    showFSBMessage("дискредитация ВС РФ");
                }
                
            } catch (error) {
                display.value = 'Error';
                displayValue = 'Error';
            }
        }

        function showFSBMessage(reason) {
            fsbReason.textContent = "Причина: " + reason;
            fsbMessage.style.display = 'flex';
            
            // Clear any existing timer
            if (fsbTimer) {
                clearTimeout(fsbTimer);
            }
            
            // Set a new timer to hide the message
            fsbTimer = setTimeout(function() {
                fsbMessage.style.display = 'none';
                fsbTimer = null;
            }, 5000);
        }

        function startBattle(enemyType) {
            battleInProgress = true;
            enemy = enemyType;
            
            // Set enemy image and stats
            if (enemyType === 'solovev') {
                enemyCharacter.src = 'solovev.png';
                enemyMaxHealth = 100;
                enemyHealth = 100;
            } else if (enemyType === 'medvedev') {
                enemyCharacter.src = 'medvedev.png';
                enemyMaxHealth = 150;
                enemyHealth = 150;
            } else if (enemyType === 'putin') {
                enemyCharacter.src = 'putin.png';
                enemyMaxHealth = 200;
                enemyHealth = 200;
            }
            
            playerHealth = 100;
            updateBattleStats();
            
            // Hide calculator and show battle screen
            document.getElementById('calculator').style.display = 'none';
            battleScreen.style.display = 'block';
            
            // Stop anthem and play battle music
            anthem.pause();
            battleMusic.currentTime = 0;
            battleMusic.play();
            
            addMessageToLog("Началась битва с " + getEnemyName(enemyType) + "!");
            addMessageToLog("Используйте Свободу слова для атаки и Демократию для лечения.");
            
            // Start enemy AI
            startEnemyAI();
        }

        function getEnemyName(enemyType) {
            switch(enemyType) {
                case 'solovev': return "Соловьёвым";
                case 'medvedev': return "Медведевым";
                case 'putin': return "Путиным";
                default: return "врагом";
            }
        }

        function updateBattleStats() {
            playerHealthValue.textContent = playerHealth;
            enemyHealthValue.textContent = enemyHealth;
            
            playerHealthFill.style.width = (playerHealth / 100 * 100) + '%';
            enemyHealthFill.style.width = (enemyHealth / enemyMaxHealth * 100) + '%';
        }

        function attackEnemy() {
            if (!battleInProgress) return;
            
            const damage = 10 + Math.floor(Math.random() * 10);
            enemyHealth -= damage;
            if (enemyHealth < 0) enemyHealth = 0;
            
            addMessageToLog("Вы атаковали " + getEnemyName(enemy) + " Свободой слова и нанесли " + damage + " урона!");
            updateBattleStats();
            
            if (enemyHealth <= 0) {
                endBattle(true);
                return;
            }
            
            // Enemy counter-attack
            setTimeout(enemyAttack, 1000);
        }

        function healPlayer() {
            if (!battleInProgress) return;
            
            const healAmount = 15 + Math.floor(Math.random() * 10);
            playerHealth += healAmount;
            if (playerHealth > 100) playerHealth = 100;
            
            addMessageToLog("Вы вылечились с помощью Демократии и восстановили " + healAmount + " здоровья!");
            updateBattleStats();
            
            // Enemy attack
            setTimeout(enemyAttack, 1000);
        }

        function enemyAttack() {
            if (!battleInProgress) return;
            
            let damage = 0;
            let attackMessage = "";
            
            if (enemy === 'solovev') {
                if (Math.random() < 0.5) {
                    damage = 10 + Math.floor(Math.random() * 10);
                    attackMessage = "Соловьёв оскорбил вас и запустил телевизором! Нанесено " + damage + " урона!";
                } else {
                    // Healing
                    const healAmount = 5 + Math.floor(Math.random() * 10);
                    enemyHealth += healAmount;
                    if (enemyHealth > enemyMaxHealth) enemyHealth = enemyMaxHealth;
                    attackMessage = "Соловьёв посмотрел на фотографию Геббельса и восстановил " + healAmount + " здоровья!";
                }
            } else if (enemy === 'medvedev') {
                if (Math.random() < 0.5) {
                    damage = 15 + Math.floor(Math.random() * 10);
                    attackMessage = "Медведев рассказал о разделе Украины с Польшей и конце света! Нанесено " + damage + " урона!";
                } else {
                    // Healing
                    const healAmount = 10 + Math.floor(Math.random() * 10);
                    enemyHealth += healAmount;
                    if (enemyHealth > enemyMaxHealth) enemyHealth = enemyMaxHealth;
                    attackMessage = "Медведев выпил водку и восстановил " + healAmount + " здоровья!";
                }
            } else if (enemy === 'putin') {
                if (Math.random() < 0.5) {
                    damage = 20 + Math.floor(Math.random() * 10);
                    attackMessage = "Путин прочитал лекцию по Рюрику и искусственности Украины! Нанесено " + damage + " урона!";
                } else {
                    // Healing
                    const healAmount = 15 + Math.floor(Math.random() * 10);
                    enemyHealth += healAmount;
                    if (enemyHealth > enemyMaxHealth) enemyHealth = enemyMaxHealth;
                    attackMessage = "Путин арестовал иноагентов и восстановил " + healAmount + " здоровья!";
                }
            }
            
            if (damage > 0) {
                playerHealth -= damage;
                if (playerHealth < 0) playerHealth = 0;
            }
            
            addMessageToLog(attackMessage);
            updateBattleStats();
            
            if (playerHealth <= 0) {
                endBattle(false);
            }
        }

        function startEnemyAI() {
            if (!battleInProgress) return;
            
            // Schedule next enemy action
            const nextAction = Math.floor(Math.random() * 3000) + 2000;
            setTimeout(function() {
                if (battleInProgress) {
                    enemyAttack();
                    startEnemyAI();
                }
            }, nextAction);
        }

        function endBattle(playerWon) {
            battleInProgress = false;
            
            if (playerWon) {
                addMessageToLog("Поздравляем! Вы победили " + getEnemyName(enemy) + "!");
                
                if (enemy === 'solovev') {
                    addPatriotism(5000);
                    addAgents(-100);
                } else if (enemy === 'medvedev') {
                    addPatriotism(50000);
                    addAgents(-500);
                } else if (enemy === 'putin') {
                    addPatriotism(500000);
                    addAgents(-1000);
                }
                
                addMessageToLog("Вы получили бонус к патриотизму и снижение уровня иноагента!");
            } else {
                addMessageToLog("Вы проиграли битву с " + getEnemyName(enemy) + "!");
                addMessageToLog("Ваши показатели патриотизма снижены!");
                addPatriotism(-Math.abs(patriotism) * 0.5);
            }
            
            // Show battle screen for a few more seconds
            setTimeout(function() {
                battleScreen.style.display = 'none';
                document.getElementById('calculator').style.display = 'block';
                
                // Stop battle music and resume anthem
                battleMusic.pause();
                anthem.currentTime = 0;
                anthem.play();
            }, 3000);
        }

        function addMessageToLog(message) {
            const p = document.createElement('p');
            p.textContent = message;
            battleLog.appendChild(p);
            battleLog.scrollTop = battleLog.scrollHeight;
        }

        // Start first vote after a delay
        setTimeout(showVoteModal, 15000);

        // Initialize stats
        updateStats();
        
        // Add event listener for body click to start audio if it hasn't started
        document.body.addEventListener('click', function() {
            if (anthem.paused) {
                anthem.play();
            }
        }, { once: true });
        
        // Also ensure FSB message can be closed by clicking on it
        fsbMessage.addEventListener('click', function() {
            if (fsbTimer) {
                clearTimeout(fsbTimer);
            }
            fsbMessage.style.display = 'none';
        });
    </script>
</body>
  </html>
